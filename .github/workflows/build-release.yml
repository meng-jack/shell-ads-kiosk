name: Build & Release (Windows)

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: "Build serial number (leave blank to auto-increment from latest release)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - name: Determine build number
        id: build_num
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $provided = "${{ github.event.inputs.build_number }}".Trim()

          if ($provided -ne "") {
            $build_number = [int]$provided
            Write-Host "Using provided build number: $build_number"
          } else {
            $headers = @{
              "Authorization" = "Bearer $env:GH_TOKEN"
              "Accept"        = "application/vnd.github.v3+json"
              "User-Agent"    = "shell-ads-kiosk-ci"
            }
            try {
              $release = Invoke-RestMethod `
                -Uri "https://api.github.com/repos/meng-jack/shell-ads-kiosk/releases/latest" `
                -Headers $headers `
                -ErrorAction Stop
              if ($release.tag_name -match '^build-(\d+)$') {
                $build_number = [int]$matches[1] + 1
              } else {
                $build_number = 1
              }
            } catch {
              # 404 = no releases yet; any other error: start from 1
              $build_number = 1
            }
            Write-Host "Auto-incremented build number: $build_number"
          }

          echo "build_number=$build_number" >> $env:GITHUB_OUTPUT
        shell: pwsh

      # ── Frontend ────────────────────────────────────────────────────────────
      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend
        shell: pwsh

      - name: Build frontend
        run: npm run build
        working-directory: frontend
        shell: pwsh

      # ── Go binary ───────────────────────────────────────────────────────────
      - name: Tidy Go modules (resolves go.sum for any new deps)
        run: go mod tidy
        shell: pwsh

      - name: Build Go binary
        run: |
          go build -v `
            -tags "desktop,production" `
            -ldflags "-X main.BuildNumber=${{ steps.build_num.outputs.build_number }} -H windowsgui" `
            -o shell-ads-kiosk-windows-x64.exe
        shell: pwsh
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 0

      # ── GitHub Release ──────────────────────────────────────────────────────
      # Uses the official GitHub CLI (pre-installed on all runners) to create the
      # release and attach the binary in a single step.  The asset is always named
      # shell-ads-kiosk-windows-x64.exe so the self-updater can locate it by a
      # known, stable name regardless of build number.
      - name: Create GitHub release and upload asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag  = "build-${{ steps.build_num.outputs.build_number }}"
          $sha  = "${{ github.sha }}".Substring(0, 7)
          $ts   = (Get-Date -Format "yyyy-MM-dd HH:mm UTC")

          $notes = @"
          ## Shell Ads Kiosk — Build ${{ steps.build_num.outputs.build_number }}

          | | |
          |---|---|
          | **Commit** | ``$sha`` |
          | **Built**  | $ts |
          | **Branch** | ``${{ github.ref_name }}`` |

          ### Download
          ``shell-ads-kiosk-windows-x64.exe`` — standalone Windows x64 executable, no installer required.

          ### Running
          ```cmd
          :: Optional – point at your playlist server
          set PLAYLIST_URL=https://api.example.com/ads/playlist.json
          shell-ads-kiosk-windows-x64.exe
          ```

          ### Self-update
          The application checks for a newer build on startup and replaces itself silently.
          Disabled when ``IS_DEV = true`` in ``config.go`` or when running without a stamped build number.
          "@

          gh release create $tag `
            --title "Build ${{ steps.build_num.outputs.build_number }}" `
            --notes $notes `
            shell-ads-kiosk-windows-x64.exe
        shell: pwsh
