name: Build & Release (Windows)

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: "Build serial number (leave blank to auto-increment from latest release)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      # ── Checkout ─────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Toolchain ────────────────────────────────────────────────────────────
      - name: Set up Go 1.24
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
        shell: pwsh

      # ── Determine build number ───────────────────────────────────────────────
      - name: Determine build number
        id: build_num
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $provided = "${{ github.event.inputs.build_number }}".Trim()
          if ($provided -ne "") {
            $build_number = [int]$provided
            Write-Host "Using provided build number: $build_number"
          } else {
            $headers = @{
              "Authorization" = "Bearer $env:GH_TOKEN"
              "Accept"        = "application/vnd.github.v3+json"
              "User-Agent"    = "ShellNews-Bernard-ci"
            }
            try {
              $release = Invoke-RestMethod `
                -Uri "https://api.github.com/repos/exoad/ShellNews-Bernard/releases/latest" `
                -Headers $headers `
                -ErrorAction Stop
              if ($release.tag_name -match '^build-(\d+)$') {
                $build_number = [int]$Matches[1] + 1
              } else {
                $build_number = 1
              }
            } catch {
              $build_number = 1
            }
            Write-Host "Auto-incremented build number: $build_number"
          }
          echo "build_number=$build_number" >> $env:GITHUB_OUTPUT
          echo "tag=build-$build_number"    >> $env:GITHUB_OUTPUT

      # ── Build kiosk (Wails) ──────────────────────────────────────────────────
      - name: Build Kiosk
        shell: pwsh
        run: |
          wails build `
            -platform windows/amd64 `
            -tags production `
            -ldflags "-s -w -X main.BuildNumber=${{ steps.build_num.outputs.build_number }}"
        # Output → build/bin/shell-ads-kiosk.exe

      # ── Build dashboard (React/TS) ───────────────────────────────────────────
      - name: Install Dashboard dependencies
        working-directory: dash
        run: npm install

      - name: Build Dashboard
        working-directory: dash
        run: npm run build
        # Output → dash/dist/

      # ── Embed dashboard into launcher ────────────────────────────────────────
      # Copies dash/dist/* → launcher/static/ so go:embed bakes it into the binary.
      # The mini PC needs zero Node/npm — the dashboard is frozen inside launcher.exe.
      - name: Embed dashboard into launcher
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force launcher\static -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path launcher\static | Out-Null
          Copy-Item -Recurse -Path dash\dist\* -Destination launcher\static\
          Write-Host "Embedded files:"
          Get-ChildItem launcher\static -Recurse | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }

      # ── Build launcher ───────────────────────────────────────────────────────
      - name: Tidy Launcher modules
        working-directory: launcher
        run: go mod tidy

      - name: Build Launcher
        working-directory: launcher
        shell: pwsh
        run: |
          go build `
            -ldflags "-s -w -X main.BuildNumber=${{ steps.build_num.outputs.build_number }}" `
            -o launcher.exe `
            .
        # Output → launcher/launcher.exe (dashboard embedded inside)

      # ── Bundle ───────────────────────────────────────────────────────────────
      - name: Bundle into zip
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path bundle | Out-Null
          Copy-Item build\bin\shell-ads-kiosk.exe bundle\kiosk.exe
          Copy-Item launcher\launcher.exe         bundle\launcher.exe

          Write-Host "`nBundle contents:"
          Get-ChildItem bundle | ForEach-Object {
            $mb = [math]::Round($_.Length / 1MB, 2)
            Write-Host "  $($_.Name)  ($mb MB)"
          }

          Compress-Archive -Path bundle\* `
            -DestinationPath shell-ads-bundle-windows-x64.zip -Force

          $mb = [math]::Round((Get-Item shell-ads-bundle-windows-x64.zip).Length / 1MB, 2)
          Write-Host "`nFinal zip: shell-ads-bundle-windows-x64.zip ($mb MB)"

      # ── Create GitHub release ─────────────────────────────────────────────────
      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $tag  = "${{ steps.build_num.outputs.tag }}"
          $num  = "${{ steps.build_num.outputs.build_number }}"
          $sha  = "${{ github.sha }}".Substring(0, 7)
          $ts   = (Get-Date -Format "yyyy-MM-dd HH:mm UTC")

          $notes = @"
          ## ShellNews Bernard — Build $num

          | | |
          |---|---|
          | **Commit** | ``$sha`` |
          | **Built**  | $ts |
          | **Branch** | ``${{ github.ref_name }}`` |

          ### Bundle contents
          | File | Description |
          |---|---|
          | ``kiosk.exe`` | Wails ad-display kiosk (Startup Shell renderer) |
          | ``launcher.exe`` | **Start this.** Launches kiosk, serves dashboard, auto-updates |

          > The dashboard (React app) is embedded inside ``launcher.exe`` — no Node.js or npm needed on the machine.

          ### First-time setup
          1. Extract ``shell-ads-bundle-windows-x64.zip`` to any folder (e.g. ``C:\kiosk\``)
          2. Run ``launcher.exe`` — that's it
          3. Dashboard → **http://localhost:6969** (tunnelled via cloudflared at shellnews.exoad.net)

          ### Updates
          ``launcher.exe`` checks for new builds every hour. When a newer build is found
          it downloads the bundle, replaces ``kiosk.exe``, self-replaces ``launcher.exe``
          (which re-embeds the latest dashboard), and restarts automatically.
          "@

          gh release create $tag `
            --title "Build $num" `
            --notes $notes `
            shell-ads-bundle-windows-x64.zip
